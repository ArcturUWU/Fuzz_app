{% extends "base.html" %}
{% block topnav %}
<div class="tabs">
  <button class="tab-link active" data-pane="editor-pane">Editor</button>
  <button class="tab-link" data-pane="fuzz-pane">Fuzz</button>
  <button class="tab-link" data-pane="analysis-pane">Analysis</button>
  <button class="tab-link" data-pane="report-pane">Report</button>
</div>
{% endblock %}
{% block content %}
{% if message %}<div class="alert alert-info">{{ message }}</div>{% endif %}
<div id="editor-pane" class="pane active">
  <div class="workspace">
    <div class="file-nav">
      <ul class="list-group">
        {% for f in project.files %}
        <li class="list-group-item file-item" data-name="{{ f.filename }}">{{ f.filename }}</li>
        {% endfor %}
      </ul>
    </div>
    <div class="editor-area">
      <form id="code-upload-form" method="post" action="/projects/{{ project.id }}/upload-code-web">
        <input type="text" name="filename" class="form-control mb-2" placeholder="Filename" required>
        <input type="hidden" name="content" id="code-content">
        <div id="editor" class="editor-container mb-2"></div>
        <button class="btn btn-secondary w-100">Save Code</button>
      </form>
      <form method="post" action="/projects/{{ project.id }}/upload-exe-web" enctype="multipart/form-data" class="mt-3">
        <input type="file" name="file" class="form-control mb-2" required>
        <button class="btn btn-secondary w-100">Upload EXE</button>
      </form>
    </div>
  </div>
</div>
<div id="fuzz-pane" class="pane">
  <form method="post" action="/projects/{{ project.id }}/fuzz-web" class="mb-3">
    {% for v in all_targets %}
    <div class="form-check">
      <input class="form-check-input" type="checkbox" name="targets" value="{{ v }}" {% if v in targets %}checked{% endif %}>
      <label class="form-check-label">{{ v }}</label>
    </div>
    {% endfor %}
    <button class="btn btn-warning mt-2">Run Fuzzing</button>
  </form>
  {% if stubbed_code %}
  <div class="row mb-3">
    <div class="col-md-6">
      <h5>Original</h5>
      <pre class="code-block">{{ original_code }}</pre>
    </div>
    <div class="col-md-6">
      <h5>Stubbed</h5>
      <pre class="code-block">{{ stubbed_code }}</pre>
    </div>
  </div>
  {% endif %}
  {% if fuzz_stats %}

  <table class="table table-sm mt-3">
    <thead>
      <tr><th>Variable</th><th>Iterations</th><th>Errors</th><th>CPU&nbsp;s</th><th>Mem&nbsp;kB</th><th>Duration&nbsp;s</th></tr>
    </thead>
    <tbody>
    {% for s in fuzz_stats %}

      <tr>
        <td>{{ s.variable }}</td>
        <td>{{ s.iterations }}</td>
        <td>{{ s.errors }}</td>
        <td>{{ '%.2f'|format(s.cpu_time) }}</td>
        <td>{{ '%.1f'|format(s.memory_kb) }}</td>
        <td>{{ '%.2f'|format(s.duration) }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  {% endif %}
</div>
<div id="analysis-pane" class="pane">
  <div class="row">
    <div class="col-md-6">
      <pre class="code-block">{{ original_code }}</pre>
    </div>
    <div class="col-md-6">
      <form method="post" action="/projects/{{ project.id }}/analyze-web">
        <textarea name="notes" class="form-control mb-2" rows="10" placeholder="Comments or focus areas"></textarea>
        <button class="btn btn-danger w-100">Analyze</button>
      </form>
      {% if analysis_result %}
      <div class="analysis-result mt-3"><pre>{{ analysis_result }}</pre></div>
      {% endif %}
    </div>
  </div>

</div>
<div id="report-pane" class="pane">
  <a href="/projects/{{ project.id }}/report-web" class="btn btn-info">Generate Report</a>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.41.0/min/vs/loader.min.js"></script>
<script>
  require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.41.0/min/vs' }});
  require(['vs/editor/editor.main'], function () {
    const data = JSON.parse(document.getElementById('files-data').textContent);
    const initialCode = JSON.parse(document.getElementById('initial-code').textContent);

    const editorEl = document.getElementById('editor');
    window.editor = monaco.editor.create(editorEl, {
      value: typeof initialCode === 'string' ? initialCode : '',
      language: 'c',
      theme: 'vs-dark',
      automaticLayout: true
    });

    document.querySelectorAll('.file-item').forEach(li => {
      li.addEventListener('click', () => {
        const name = li.dataset.name;
        if (name in data) {
          window.editor.setValue(data[name] ?? '');
          const fn = document.querySelector('input[name="filename"]');
          if (fn) fn.value = name;
        }
      });
    });
  });

  const form = document.getElementById('code-upload-form');
  if (form) {
    form.addEventListener('submit', function () {
      const hidden = document.getElementById('code-content');
      if (hidden && window.editor) hidden.value = window.editor.getValue();
    });
  }
</script>
{% endblock %}
