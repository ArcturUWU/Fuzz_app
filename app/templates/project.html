{% extends "base.html" %}
{% block topnav %}
<div class="tabs">
  <button class="tab-link active" data-pane="editor-pane">Editor</button>
  <button class="tab-link" data-pane="fuzz-pane">Fuzz</button>
  <button class="tab-link" data-pane="analysis-pane">Analysis</button>
  <button class="tab-link" data-pane="report-pane">Report</button>
</div>
{% endblock %}
{% block content %}
{% if message %}<div class="alert alert-info">{{ message }}</div>{% endif %}
<div id="editor-pane" class="pane active">
  {% if project.files %}
  <ul class="list-group mb-3">
    {% for f in project.files %}
    <li class="list-group-item">{{ f.filename }}</li>
    {% endfor %}
  </ul>
  {% endif %}
  <form id="code-upload-form" method="post" action="/projects/{{ project.id }}/upload-code-web">
    <input type="text" name="filename" class="form-control mb-2" placeholder="Filename" required>
    <input type="hidden" name="content" id="code-content">
    <div id="editor" class="editor-container mb-2"></div>
    <button class="btn btn-secondary">Save Code</button>
  </form>
  <form method="post" action="/projects/{{ project.id }}/upload-exe-web" enctype="multipart/form-data" class="mt-3">
    <input type="file" name="file" class="form-control mb-2" required>
    <button class="btn btn-secondary">Upload EXE</button>
  </form>
</div>
<div id="fuzz-pane" class="pane">
  <form method="post" action="/projects/{{ project.id }}/fuzz-web">
    <button class="btn btn-warning">Run Fuzzing</button>
  </form>
  {% if project.fuzz_stats %}
  <table class="table table-sm mt-3">
    <thead>
      <tr><th>Variable</th><th>Iterations</th><th>Errors</th><th>CPU&nbsp;s</th><th>Mem&nbsp;kB</th><th>Duration&nbsp;s</th></tr>
    </thead>
    <tbody>
    {% for s in project.fuzz_stats %}
      <tr>
        <td>{{ s.variable }}</td>
        <td>{{ s.iterations }}</td>
        <td>{{ s.errors }}</td>
        <td>{{ '%.2f'|format(s.cpu_time) }}</td>
        <td>{{ '%.1f'|format(s.memory_kb) }}</td>
        <td>{{ '%.2f'|format(s.duration) }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  {% endif %}
</div>
<div id="analysis-pane" class="pane">
  <form method="post" action="/projects/{{ project.id }}/analyze-web">
    <button class="btn btn-danger">Analyze</button>
  </form>
  {% if project.analyses %}
  <ul class="list-group mt-3">
    {% for a in project.analyses %}
    <li class="list-group-item"><pre class="mb-0">{{ a.result }}</pre></li>
    {% endfor %}
  </ul>
  {% endif %}
</div>
<div id="report-pane" class="pane">
  <a href="/projects/{{ project.id }}/report-web" class="btn btn-info">Generate Report</a>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.41.0/min/vs/loader.min.js"></script>
<script>
  const tabs = document.querySelectorAll('.tab-link');
  const panes = document.querySelectorAll('.pane');
  tabs.forEach(t => {
    t.addEventListener('click', () => {
      tabs.forEach(b => b.classList.remove('active'));
      panes.forEach(p => p.classList.remove('active'));
      t.classList.add('active');
      document.getElementById(t.dataset.pane).classList.add('active');
    });
  });
  require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.41.0/min/vs' }});
  require(['vs/editor/editor.main'], function() {
    window.editor = monaco.editor.create(document.getElementById('editor'), {
      value: {{ project.files[0].content|tojson if project.files else '""' }},
      language: 'c',
      theme: 'vs-dark'
    });
  });
  document.getElementById('code-upload-form').addEventListener('submit', function(){
    document.getElementById('code-content').value = window.editor.getValue();
  });
</script>
{% endblock %}
